---
title: Jenkinsæ•™ç¨‹
date: 2022-04-26 17:07:36
permalink: /pages/035670/
categories:
  - jenkinsæ•™ç¨‹
tags:
  - 
author: 
  name: xugaoyi
  link: https://github.com/xugaoyi
sticky: 1
---

## jenkinsæ­å»º

#### 1.ç¯å¢ƒä¿¡æ¯

````tex
JDK1.8
maven 3.5.4
jenkins laster 
````

#### 2.mavené…ç½®ä»“åº“

````xml
<mirrors>
    <mirror>
        <id>nexus-aliyun</id>
        <mirrorOf>central</mirrorOf>
        <name>Nexus aliyun</name>
        <url>http://maven.aliyun.com/nexus/content/groups/public</url>
    </mirror>	
</mirrors>
````

#### 3.dockeræ–¹å¼å®‰è£…jekins

â€‹	3.1 dockeræ‹‰å–jekins

````tex
docker pull jenkins/jenkins:lts
````

â€‹	3.2 åˆ›å»ºæŒ‚è½½ç›®å½• å¹¶å¼€æ”¾è¯»å†™æƒé™

```
mkdir -p /opt/work/jenkins
chmod 777 /opt/work/jenkins
chown -R 1000 /opt/work/jenkins
```

â€‹	3.3 å¯åŠ¨

```
docker run -d --name jenkins -p 9000:8080 -p 50000:50000  --restart=always -v /opt/work/jenkins:/var/jenkins_home -v /etc/localtime:/etc/localtime -v /opt/work/apache-maven-3.5.4:/usr/local/maven jenkins/jenkins:lts
```

â€‹	3.4è¿›å…¥æ§åˆ¶å°

```
http://ip:9000
ç­‰å¾…ç•Œé¢åˆå§‹åŒ–è¿›å…¥è§£é”ç•Œé¢
```

![image-20220419170953533](http://images.yueshuge.cn:9000/images/jenkins/image-20220419170953533.png)	

3.5æŸ¥çœ‹åˆå§‹åŒ–å¯†ç 

```
docker exec -it jenkins bash
cat /var/jenkins_home/secrets/initialAdminPassword
```

3.6é€‰æ‹©å®‰è£…æ’ä»¶çš„æ–¹å¼

â€‹	å¦‚æœçŸ¥é“è¦å®‰è£…å“ªäº›æ’ä»¶ï¼Œå°±é€‰æ‹©å®‰è£…æ¨èçš„æ’ä»¶ã€‚

![image-20220419171142753](http://images.yueshuge.cn:9000/images/jenkins/image-20220419171142753.png)

3.7ç­‰å¾…å®‰è£…å®Œæˆï¼Œåç»­æ­¥éª¤æŒ‰ç…§ç•Œé¢æç¤ºå³å¯

#### 4.å®‰è£…æ’ä»¶

![image-20220419173953533](http://images.yueshuge.cn:9000/images/jenkins/image-20220419173953533.png)

```
ä¸»è¦å®‰è£…ä»¥ä¸‹å‡ ä¸ªæ’ä»¶ï¼Œåœ¨å³ä¸Šè§’è¿›è¡Œæœç´¢
Publish Over SSH -- æœåŠ¡å™¨æ“ä½œæ’ä»¶ é…ç½®æœåŠ¡å™¨ä¿¡æ¯ -- æš‚æœªç”¨åˆ°è¯¥æ–¹å¼
SSH2 Easy     -----  æœåŠ¡å™¨æ“ä½œæ’ä»¶ é…ç½®æœåŠ¡å™¨ä¿¡æ¯
Maven Integration ----- mavenæ’ä»¶ å‘å¸ƒJARåŒ…ç”¨
Git Parameter ----- gitæ’ä»¶	æ‹‰å–ä»£ç ç”¨
NodeJS Plugin ----- nodejsæ’ä»¶ å‘å¸ƒVUEç”¨
å®‰è£…å®Œåé‡å¯å‹¾é€‰å³ä¸‹è§’é‡å¯æœåŠ¡
```

![image-20220419174434105](http://images.yueshuge.cn:9000/images/jenkins/image-20220419174434105.png)

#### 5.é…ç½®jenkins

è¿›å…¥é…ç½®ç•Œé¢

![image-20220419172023563](http://images.yueshuge.cn:9000/images/jenkins/image-20220419172023563.png)

5.1å…¨å±€ç¯å¢ƒé…ç½®

```
è¿›å…¥å®¹å™¨
docker exec -it jenkins bash
æŸ¥çœ‹java home
echo $JAVA_HOME è·å–javaè·¯å¾„
ç•Œé¢ç‚¹å‡»æ–°å¢jdk å–æ¶ˆè‡ªåŠ¨å®‰è£…
/opt/java/openjdk
```

![image-20220419173114656](http://images.yueshuge.cn:9000/images/jenkins/image-20220419173114656.png)

5.2é…ç½®maven

```
å–æ¶ˆè‡ªåŠ¨å®‰è£…
åœ¨ç¬¬3.3æ­¥éª¤ä¸­å¯åŠ¨æ—¶é…ç½®äº†mavenè·¯å¾„usr/local/maven å¤åˆ¶è·¯å¾„å¡«å…¥ä¸‹é¢æ¡†æ ¼
```

![image-20220419173316137](http://images.yueshuge.cn:9000/images/jenkins/image-20220419173316137.png)

5.3é…ç½®nodejs

```
è¿™ä¸ªéœ€è¦ç‰¹åˆ«æ³¨æ„ï¼Œéœ€è¦æ ¹æ®ç›®å‰å¼€å‘çš„VUEç‰ˆæœ¬å®‰è£…å¯¹åº”çš„æ”¯æŒç‰ˆæœ¬ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´æ„å»ºå¤±è´¥ã€‚æˆ‘ç¬¬ä¸€æ¬¡å®‰è£…äº†nodejs14çš„ç‰ˆæœ¬å°±ç”±äºç‰ˆæœ¬è¿‡é«˜å¯¼è‡´æ„å»ºå¤±è´¥ï¼Œåæ¥é‡æ–°å®‰è£…äº†nodejs 12.16.2æ‰æ­£å¸¸æ„å»ºæˆåŠŸã€‚
```

![image-20220425142544749](http://images.yueshuge.cn:9000/images/jenkins/image-20220425142544749.png)

#### 6.ç³»ç»Ÿé…ç½®

â€‹	ç‚¹å‡»ç³»ç»Ÿè®¾ç½®-ç³»ç»Ÿè®¾ç½® ![image-20220419183338862](http://images.yueshuge.cn:9000/images/jenkins/image-20220419183338862.png)

**6.1 Server Groups Center é…ç½®æœåŠ¡å™¨ä¿¡æ¯**

![image-20220425143724262.png](http://images.yueshuge.cn:9000/images/jenkins/image-20220425143724262.png)

```
é…ç½®å®Œæˆä¹‹å,éœ€è¦å…ˆä¿å­˜é€€å‡ºé…ç½®ç•Œé¢ï¼Œå†è¿›å…¥æ‰å¯ä»¥é…ç½®Server Listï¼Œå¦åˆ™å¯èƒ½æ‰¾ä¸åˆ°Server Group
```

6.2 é…ç½®Server Group List

![image-20220425144059505](http://images.yueshuge.cn:9000/images/jenkins/image-20220425144059505.png)

#### 7.æ„å»ºjavaé¡¹ç›®

```
ç‚¹å‡»å·¦ä¾§èœå•æ–°å»ºä»»åŠ¡ï¼Œç„¶åé€‰æ‹©æ„å»ºä¸€ä¸ªMAVENé¡¹ç›®
```

![image-20220419181531513](image-20220419181531513.png)

7.1æ„å»ºç­–ç•¥

```
æ„å»ºçš„ç‰ˆæœ¬ä¿ç•™å‡ ä¸ªä½œä¸ºå›æ»šå°±å¤Ÿäº†ï¼Œä¸éœ€è¦ä¸€ç›´ä¿ç•™ç€ï¼Œä»¥å…å ç”¨æœåŠ¡å™¨ç¡¬ç›˜èµ„æºã€‚
ç‚¹å‡»Generalå‹¾é€‰ä¸¢å¼ƒæ—§çš„æ„å»ºï¼Œæ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µå¤‡ä»½ä»¥ä¸‹2ä¸ªä¿¡æ¯
	ä¿æŒæ„å»ºçš„å¤©æ•°
	ä¿æŒæ„å»ºçš„æœ€å¤§ä¸ªæ•°
è¿˜å¯ä»¥å‹¾é€‰å‚æ•°åŒ–æ„å»ºè¿‡ç¨‹ï¼Œå¯¹ä¸€äº›ä¿¡æ¯å‚æ•°åŒ–ã€‚ï¼ˆè¿™ä¸€æ­¥æˆ‘æš‚æ—¶æœªåšï¼‰
```

![image-20220425144625500](http://images.yueshuge.cn:9000/images/jenkins/image-20220425144625500.png)

7.2 gité…ç½®

```
ç‚¹å‡»æºç ç®¡ç†é…ç½®gitä¿¡æ¯ï¼Œè¾“å…¥URL æ·»åŠ è®¤è¯ é€‰æ‹©è¦æ„å»ºçš„åˆ†æ”¯
å¦‚æœåšäº†å‚æ•°åŒ–æ„å»ºï¼Œè¿™é‡Œå°±å¯ä»¥é…ç½®å‚æ•°ã€‚
```

![image-20220419181923115](http://images.yueshuge.cn:9000/images/jenkins/image-20220419181923115.png)

7.3 å–æ¶ˆæ„å»ºè§¦å‘å™¨

```
åœ¨æ„å»ºè§¦å‘å™¨ å–æ¶ˆå‹¾é€‰ â€œBuild whenever a SNAPSHOT dependency is builtâ€
```

7.4 é…ç½®mavenæ„å»ºå‘½ä»¤

```
å¦‚æœæ˜¯å•æ¨¡å—é¡¹ç›®ï¼Œåˆ™ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å³å¯
clean install xxx -Dmaven.test.skip=true
å¦‚æœæ˜¯å¤šæ¨¡å—é¡¹ç›®ï¼Œåˆ™éœ€è¦ç¡®è®¤æ„å»ºçš„æ‰§è¡Œé¡¹ç›®
clean install -pl xxx -am -amd -Dmaven.test.skip=true
-pl æ ‡è¯†æŒ‡å®šæ„å»ºæŸä¸ªæ¨¡å—
-am æ˜¯å‘ä¸‹çš„ã€‚è¡¨ç¤ºåŒæ—¶å¤„ç†é€‰å®šæ¨¡å—æ‰€ä¾èµ–çš„æ¨¡å—ã€‚
-amd æ˜¯å‘ä¸Šçš„ã€‚è¡¨ç¤ºåŒæ—¶å¤„ç†ä¾èµ–é€‰å®šæ¨¡å—çš„æ¨¡å—ã€‚
ä½¿ç”¨-amã€-amdç­‰æ—¶å€™ï¼Œå¿…é¡»é…åˆ-plæŒ‡å®šæ¨¡å—ä½¿ç”¨
```

![image-20220425145243439](http://images.yueshuge.cn:9000/images/jenkins/image-20220425145243439.png)

7.5 é…ç½®FTPä¸Šä¼ 

```
æˆ‘æ²¡æœ‰ä½¿ç”¨SSHä¸Šä¼ æ–¹å¼ï¼ˆæ‡’çš„å¼„è¯ä¹¦ğŸ˜‚ï¼‰
é…ç½®FTPæ–¹å¼ä¸Šä¼ åŒ…
Run only if build succeed æ ‡è¯†æ„å»ºæˆåŠŸåæ‰æ‰§è¡Œ
target serverå¯¹åº”çš„æ˜¯jenkinså®¹å™¨é‡Œé¢çš„ç»å¯¹è·¯å¾„
/var/jenkins_home/workspace/é¡¹ç›®è·¯å¾„/target/jaråŒ…å.jar
remoteLocation  è¡¨ç¤ºè¦ä¸Šä¼ åˆ°è¿œç¨‹æœåŠ¡å™¨çš„å“ªä¸ªä½ç½®
fileName è¡¨ç¤ºä¸Šä¼ ä¹‹åæ–‡ä»¶çš„åç§°
```

![image-20220425150659343](http://images.yueshuge.cn:9000/images/jenkins/image-20220425150659343.png)

7.6 æ‰§è¡Œè¿œç¨‹è„šæœ¬æˆ–è€…å‘½ä»¤å‘èµ·éƒ¨ç½²

![image-20220425151109499](http://images.yueshuge.cn:9000/images/jenkins/image-20220425151109499.png)

```sh
# dockeræ„å»ºéƒ¨ç½²å‘½ä»¤ä¾‹å­
export BUILD_ID=dontKillMe 
innerport=8086 #dockerå®¹å™¨å†…éƒ¨ç«¯å£
outport=8081 #dockerå®¹å™¨å¤–éƒ¨ç«¯å£
dockername=api #å®¹å™¨åç§°
web=api-0.0.1-SNAPSHOT #jaråŒ…å
webdir=/opt/work/api #dockeræ„å»ºè·¯å¾„
backup=/opt/work/backup #å¤‡ä»½è·¯å¾„
bulid=/opt/work/bulid #jenkins ä¸Šä¼ çš„è·¯å¾„
date=$(date +%Y%m%d%H%M) #å¤‡ä»½çš„æ–‡ä»¶åç¼€
echo "####### å¤‡ä»½jaråŒ… ##########"
cp $webdir/$web.jar $backup/$web-$date.jar #å¤‡ä»½å†å²ç‰ˆæœ¬
rm -rf $webdir/$web.jar #åˆ é™¤å†å²ç‰ˆæœ¬
mv $bulid/$web.jar $webdir/$web.jar #æ‹·è´æœ€æ–°ç‰ˆæœ¬åˆ° æ„å»ºè·¯å¾„
echo "####### åˆ é™¤å½“å‰å®¹å™¨ ##########"
docker stop $dockername
sleep 10
docker rm $dockername
sleep 3
docker rmi $dockername
sleep 3
echo "####### åˆ¶ä½œæœ€æ–°çš„å½“å‰é•œåƒ ##########"
cd $webdir #è¿›å…¥æ„å»ºè·¯å¾„
docker build -t $dockername .
echo "####### å¯åŠ¨å½“å‰æœ€æ–°çš„å®¹å™¨ ##########"
docker run -d --name $dockername -p $outport:$innerport $dockername
sleep 5
pid=`ps aux|grep $dockername|grep -v grep |grep -v "/bin/sh"| awk '{print $2}'`
if [ -z "${pid}" ]; then
echo "################################é¡¹ç›®å¯åŠ¨å¤±è´¥################################"
cat dsadsadas #ä½¿jenkinså‘å¸ƒå¤±è´¥ï¼Œå¯¼è‡´æ„å»ºé¡¹ç›®ä¸ç¨³å®š
else
echo "################################é¡¹ç›®å¯åŠ¨æˆåŠŸ#########################################"
fi
```

#### 8.æ„å»ºVUEé¡¹ç›®

```
å¤§éƒ¨åˆ†çš„æ“ä½œå’Œæ„å»ºJavaé¡¹ç›®ä¸€è‡´ï¼Œç•¥å¾®æœ‰ç‚¹å°åŒºåˆ«ã€‚
ç¬¬ä¸€æ­¥é€‰æ‹©æ„å»ºä¸€ä¸ªè‡ªç”±é£æ ¼çš„è½¯ä»¶é¡¹ç›®
ç¬¬ä¸€æ¬¡æ„å»ºè¦å®‰è£…nodejsï¼Œæ—¶é—´ä¼šä¹…ç‚¹
```

![image-20220425151507345](http://images.yueshuge.cn:9000/images/jenkins/image-20220425151507345.png)

```
1-3æ­¥ä¸ç¬¬7ç‚¹ä¸€è‡´
```

8.1 æ„å»ºç¯å¢ƒé€‰æ‹©nodejs

```
1.è¦é€‰æ‹©å®‰è£…nodejsæ’ä»¶ï¼Œåœ¨ç¬¬4ç‚¹å·²å®‰è£…
2.ç‚¹å‡»æ„å»ºç¯å¢ƒï¼Œå‹¾é€‰Provide Node & npm bin/ folder to PATH
```

![image-20220425152203592](http://images.yueshuge.cn:9000/images/jenkins/image-20220425152203592.png)

8.2æ–°å¢æ‰§è¡Œshellå‘½ä»¤

```sh
cnpm install
cnpm run build
cd /var/jenkins_home/workspace/xxx
tar -cvf dist.tar dist/
```

![image-20220425152426427](http://images.yueshuge.cn:9000/images/jenkins/image-20220425152426427.png)

8.3 FTPä¸Šä¼ 

![image-20220425162417479](http://images.yueshuge.cn:9000/images/jenkins/image-20220425162417479.png)

8. 4 æ‰§è¡Œè¿œç¨‹shellå‘½ä»¤

   ![image-20220425162613254](http://images.yueshuge.cn:9000/images/jenkins/image-20220425162613254.png)

```sh
export BUILD_ID=dontKillMe
innerport=8080
outport=8080
dockername=vue
web=dist
webdir=/opt/work/vue
backup=/opt/work/backup
bulid=/opt/work/bulid
date=$(date +%Y%m%d%H%M)
echo "####### å¤‡ä»½jaråŒ… ##########"
cd $webdir
tar -cvf $web.tar  $web
cp $webdir/$web.tar $backup/$web-$date.tar
rm -rf $webdir/$web.tar
mv $bulid/$web.tar $webdir/$web.tar
tar -xvf $web.tar
rm -rf $web.tar
echo "####### åˆ é™¤å½“å‰å®¹å™¨ ##########"
docker stop $dockername
sleep 10
docker rm $dockername
sleep 3
docker rmi $dockername
sleep 3
echo "####### åˆ¶ä½œæœ€æ–°çš„å½“å‰é•œåƒ ##########"
docker build -t $dockername .
echo "####### å¯åŠ¨å½“å‰æœ€æ–°çš„å®¹å™¨ ##########"
docker run -d --name $dockername -p $outport:$innerport $dockername
sleep 5
pid=`ps aux|grep $dockername|grep -v grep |grep -v "/bin/sh"| awk '{print $2}'`
if [ -z "${pid}" ]; then
echo "################################é¡¹ç›®å¯åŠ¨å¤±è´¥################################"
cat dsadsadas #ä½¿jenkinså‘å¸ƒå¤±è´¥ï¼Œå¯¼è‡´æ„å»ºé¡¹ç›®ä¸ç¨³å®š
else
echo "################################é¡¹ç›®å¯åŠ¨æˆåŠŸ#########################################"
fi
```

8.5 ä¸Šä¼ æˆåŠŸä¹‹åï¼Œåˆ é™¤åŒ…

```
cd /var/jenkins_home/workspace/xxx
rm -rf dist.tar
```

![image-20220425164041411](http://images.yueshuge.cn:9000/images/jenkins/image-20220425164041411.png)

#### 9.é—®é¢˜

ç›®å‰ç¢°åˆ°çš„å¤§éƒ¨åˆ†é—®é¢˜éƒ½æ˜¯æƒé™ä¸è¶³çš„é—®é¢˜

ä»“åº“çš„æƒé™ä¸è¶³

```
chmod 777 -R /jenkinsä¸»ç›®å½•/.m2/repository
```

bulid ç›®å½•æƒé™ä¸è¶³

```
chmod 777 -R xxx
```

è„šæœ¬æ‰§è¡Œå¼‚å¸¸ shè„šæœ¬è¦é€šè¿‡touchåˆ›å»ºï¼Œå¦‚æœä»windowæ”¾ä¸Šå»æœ‰å­—ç¬¦çš„é—®é¢˜

